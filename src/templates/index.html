<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>DEEPSHARK</title>
    
    <!-- External resources (all using HTTPS) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Jersey+15&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>

    <!-- Local static files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css', _external=True, _scheme='https') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', _external=True, _scheme='https') }}">
    {% if name=="tutorial.html" %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tutorial.css', _external=True, _scheme='https') }}">
    {% endif %}

    <svg style="display:none">
        <symbol id="icon-copy" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
        </symbol>
    </svg>
    <script>hljs.highlightAll();</script>
</head>

<body>
    <!-- Header content remains the same -->
    <header>
        [... giữ nguyên phần header ...]
    </header>

    <main>
        {% if name != "tutorial.html" %}
            {% include name %}
        {% else %}
            <div class="content">{{ content|safe }}</div>
        {% endif %}
    </main>

    <footer>
        [... giữ nguyên phần footer ...]
    </footer>

    <!-- JavaScript files -->
    {% if name=="tutorial.html" %}
    <script src="{{ url_for('static', filename='js/app.js', _external=True, _scheme='https') }}"></script>
    <script src="{{ url_for('static', filename='js/addCopyButton.js', _external=True, _scheme='https') }}"></script>
    {% endif %}
    
    <script src="{{ url_for('static', filename='js/hiddenbutton.js', _external=True, _scheme='https') }}" defer></script>
    <script src="{{ url_for('static', filename='js/update_chathistory.js', _external=True, _scheme='https') }}" defer></script>

    <!-- Inline scripts -->
    <script>
        // Toggle functionality
        document.querySelector('.toggle').addEventListener('click', function() {
            const elementsToToggle = [
                '.logo', 
                '.new-chat-btn', 
                '.for-chat', 
                '.auth-buttons'
            ];
            
            elementsToToggle.forEach(selector => {
                document.querySelector(selector).classList.toggle('hidden');
            });

            document.querySelector('header').classList.toggle('shrunk');
            
            const icon = document.querySelector('.toggle-icon');
            icon.classList.toggle('bx-chevron-left-square');
            icon.classList.toggle('bx-chevron-right-square');
        });

        // Responsive behavior
        window.addEventListener('resize', function() {
            const header = document.querySelector('header');
            if (window.matchMedia("(min-width: 1024px)").matches) {
                header.classList.remove('hidden');
            } else if (document.querySelector('.logo').classList.contains('hidden')) {
                ['logo', 'new-chat', 'for-chat', 'auth-buttons', 'new-chat-btn'].forEach(className => {
                    document.querySelector(`.${className}`).classList.remove('hidden');
                });
            }
        });

        // Socket.io initialization
        const socket = io();
        socket.on('connect', () => console.log('Connected to Socket.IO server'));
        
        socket.on('update_history', async () => {
            try {
                const response = await fetch('/chat-history');
                const data = await response.json();
                const container = document.getElementById('history-items');
                
                container.innerHTML = data.map(chat => `
                    <a href="javascript:void(0)" class="history-item" data-chat-id="${chat.id}">
                        ${chat.name}<br>
                    </a>
                    <hr>
                `).join('');
            } catch (error) {
                console.error('Error updating chat history:', error);
            }
        });
    </script>
</body>
</html>